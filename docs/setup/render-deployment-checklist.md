# ðŸš€ Render Deployment Checklist

**Project:** GP Bikes AI Assistant  
**Last Updated:** October 1, 2025  
**Estimated Time:** 4-6 hours (first deployment)

---

## ðŸ“‹ Pre-Deployment Checklist

### âœ… Accounts & Access

- [ ] **Render Account Created**
  - Sign up: https://dashboard.render.com/register
  - Email verified
  - Payment method added (required for Starter plans and above)

- [ ] **GitHub Repository Connected**
  - Repository: https://github.com/YOUR-ORG/gp-bikes-ai-assistant
  - Render has read access
  - `production` branch exists

- [ ] **AWS Account (for S3)**
  - Account created: https://aws.amazon.com
  - IAM user with S3 access created
  - Access Key ID and Secret Access Key saved securely (1Password)

- [ ] **OpenAI Account**
  - API key obtained: https://platform.openai.com/api-keys
  - Payment method added (OpenAI charges separately)
  - Rate limits understood ($100/month initially)

- [ ] **Meta Business Manager (WhatsApp)**
  - Business Manager account: https://business.facebook.com
  - WhatsApp Business API approved
  - Phone Number ID obtained
  - Access Token generated
  - Webhook verify token generated: `openssl rand -hex 32`

- [ ] **Sentry (Error Tracking - Optional)**
  - Account created: https://sentry.io
  - Project created: "gp-bikes-production"
  - DSN saved

---

## ðŸ”§ Environment Setup

### âœ… Repository Configuration

- [ ] **`render.yaml` Blueprint Created**
  ```bash
  # File should exist at repository root
  ls render.yaml
  ```

- [ ] **Build Script Executable**
  ```bash
  chmod +x bin/render-build.sh
  git add bin/render-build.sh render.yaml
  git commit -m "Add Render deployment configuration"
  git push origin production
  ```

- [ ] **Rails Master Key Secured**
  ```bash
  # NEVER commit this file to Git
  cat config/master.key  # Copy value to 1Password
  ```

- [ ] **Environment Variables Prepared**
  - [ ] `SECRET_KEY_BASE` - Auto-generated by Render
  - [ ] `RAILS_MASTER_KEY` - From config/master.key
  - [ ] `OPENAI_API_KEY` - From OpenAI dashboard
  - [ ] `WHATSAPP_PHONE_NUMBER_ID` - From Meta Business Manager
  - [ ] `WHATSAPP_ACCESS_TOKEN` - From Meta Business Manager
  - [ ] `WHATSAPP_WEBHOOK_VERIFY_TOKEN` - Generated with openssl
  - [ ] `AWS_ACCESS_KEY_ID` - From AWS IAM
  - [ ] `AWS_SECRET_ACCESS_KEY` - From AWS IAM
  - [ ] `S3_BUCKET_NAME` - S3 bucket name
  - [ ] `GP_BIKES_WHATSAPP_NUMBER` - Format: +57XXXXXXXXXX
  - [ ] `SENTRY_DSN` (optional) - From Sentry project

---

### âœ… S3 Bucket Setup

- [ ] **Create S3 Bucket**
  ```bash
  aws s3 mb s3://gp-bikes-production-uploads --region us-west-2
  ```

- [ ] **Configure CORS**
  ```bash
  cat > cors.json << EOF
  {
    "CORSRules": [
      {
        "AllowedOrigins": ["https://gp-bikes.onrender.com"],
        "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
        "AllowedHeaders": ["*"],
        "ExposeHeaders": ["ETag"],
        "MaxAgeSeconds": 3000
      }
    ]
  }
  EOF
  
  aws s3api put-bucket-cors --bucket gp-bikes-production-uploads --cors-configuration file://cors.json
  ```

- [ ] **Set Bucket Policy (Public Read for Avatars)**
  ```bash
  cat > policy.json << EOF
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "PublicReadGetObject",
        "Effect": "Allow",
        "Principal": "*",
        "Action": "s3:GetObject",
        "Resource": "arn:aws:s3:::gp-bikes-production-uploads/public/*"
      }
    ]
  }
  EOF
  
  aws s3api put-bucket-policy --bucket gp-bikes-production-uploads --policy file://policy.json
  ```

- [ ] **Enable Versioning (Recommended)**
  ```bash
  aws s3api put-bucket-versioning \
    --bucket gp-bikes-production-uploads \
    --versioning-configuration Status=Enabled
  ```

- [ ] **Configure Lifecycle Rules (Cost Optimization)**
  ```bash
  cat > lifecycle.json << EOF
  {
    "Rules": [
      {
        "Id": "DeleteOldVersions",
        "Status": "Enabled",
        "NoncurrentVersionExpiration": {
          "NoncurrentDays": 30
        }
      },
      {
        "Id": "TransitionToIA",
        "Status": "Enabled",
        "Transitions": [
          {
            "Days": 90,
            "StorageClass": "STANDARD_IA"
          }
        ]
      }
    ]
  }
  EOF
  
  aws s3api put-bucket-lifecycle-configuration \
    --bucket gp-bikes-production-uploads \
    --lifecycle-configuration file://lifecycle.json
  ```

---

## ðŸš€ Deployment Steps

### Step 1: Deploy to Staging (Optional but Recommended)

- [ ] **Create Staging Environment**
  ```bash
  # Create staging branch
  git checkout -b staging
  git push origin staging
  ```

- [ ] **Deploy with Render Blueprint (Staging)**
  1. Go to Render Dashboard: https://dashboard.render.com
  2. Click "New" â†’ "Blueprint"
  3. Select repository: `gp-bikes-ai-assistant`
  4. Branch: `staging`
  5. Blueprint file: `render.yaml`
  6. Click "Apply"
  
  **Staging Plan Adjustments:**
  - Web Service: `starter` (512MB) - $7/month
  - Worker Service: `starter` (512MB) - $7/month
  - PostgreSQL: `starter` (1GB) - $7/month
  - Redis: `free` (25MB) - $0/month
  - **Total: $21/month**

- [ ] **Set Staging Environment Variables**
  - All same as production but with `_staging` suffix
  - Use separate S3 bucket: `gp-bikes-staging-uploads`
  - Use separate OpenAI API key (optional, for budget tracking)

- [ ] **Wait for Deployment (~10 minutes)**
  - Watch logs in Render Dashboard
  - Services: `gp-bikes-web`, `gp-bikes-worker`
  - Databases: `gp-bikes-postgres`, `gp-bikes-redis`

- [ ] **Verify Staging Health**
  ```bash
  curl -I https://gp-bikes-staging.onrender.com/api/v1/health
  # Expected: HTTP/2 200
  ```

- [ ] **Run Smoke Tests on Staging**
  - [ ] Can access Chatwoot login page
  - [ ] Can create test conversation
  - [ ] Can send test WhatsApp message
  - [ ] AI workers responding (check Sidekiq dashboard)
  - [ ] No errors in Sentry

---

### Step 2: Deploy to Production

- [ ] **Merge Staging to Production** (if staging tests passed)
  ```bash
  git checkout production
  git merge staging
  git push origin production
  ```

- [ ] **Deploy with Render Blueprint (Production)**
  1. Render Dashboard â†’ "New" â†’ "Blueprint"
  2. Repository: `gp-bikes-ai-assistant`
  3. Branch: `production`
  4. Blueprint file: `render.yaml`
  5. Click "Apply"

- [ ] **Set Production Environment Variables**
  - Navigate to each service â†’ "Environment"
  - Add all missing secrets (see checklist above)
  - Verify database connection strings are auto-populated

- [ ] **Wait for Build & Deployment (~15 minutes)**
  - Watch build logs: "Build" tab
  - Watch deployment logs: "Logs" tab
  - Wait for health check to pass (green checkmark)

---

### Step 3: Post-Deployment Verification

- [ ] **Health Check Passes**
  ```bash
  curl https://gp-bikes.onrender.com/api/v1/health | jq
  ```
  
  **Expected Response:**
  ```json
  {
    "status": "healthy",
    "checks": {
      "database": {"status": "ok", "latency_ms": 5},
      "redis": {"status": "ok"},
      "sidekiq": {"status": "ok", "workers": 10},
      "storage": {"status": "ok"}
    },
    "version": "production-abc123",
    "timestamp": "2025-10-01T12:00:00Z"
  }
  ```

- [ ] **Database Migrations Ran Successfully**
  ```bash
  # Check release command logs
  render logs gp-bikes-web --type release
  # Should see: "== 20250101120000 CreateAiWorkersTable: migrated =="
  ```

- [ ] **pgvector Extension Enabled**
  ```bash
  render ssh gp-bikes-web
  bundle exec rails runner 'puts ActiveRecord::Base.connection.execute("SELECT * FROM pg_extension WHERE extname = \"pgvector\"").count'
  # Expected output: 1
  exit
  ```

- [ ] **All Services Running**
  - Render Dashboard â†’ Services
  - `gp-bikes-web`: 2 instances, status "Running"
  - `gp-bikes-worker`: 1 instance, status "Running"

- [ ] **Sidekiq Processing Jobs**
  ```bash
  open https://gp-bikes.onrender.com/sidekiq
  # Login with Chatwoot admin credentials
  # Check: Workers > 0, Queues with 0 lag
  ```

- [ ] **Active Storage Working (S3)**
  ```bash
  render ssh gp-bikes-web
  bundle exec rails console
  > ActiveStorage::Blob.service.upload("test", StringIO.new("test content"))
  > ActiveStorage::Blob.last.key
  # Should return a key, and file should exist in S3
  exit
  ```

- [ ] **OpenAI API Connected**
  ```bash
  render ssh gp-bikes-web
  bundle exec rails console
  > require 'openai'
  > client = OpenAI::Client.new(access_token: ENV['OPENAI_API_KEY'])
  > response = client.models.list
  > response.dig('data').first
  # Should return model info (gpt-4, etc.)
  exit
  ```

- [ ] **No Critical Errors in Logs**
  ```bash
  # Web logs (last 100 lines)
  render logs gp-bikes-web --tail 100
  
  # Worker logs
  render logs gp-bikes-worker --tail 100
  
  # No lines with: ERROR, FATAL, CRITICAL
  ```

- [ ] **Sentry Receiving Events** (if configured)
  - Go to Sentry dashboard
  - Check last event timestamp (should be recent)
  - Verify environment is "production"

---

### Step 4: WhatsApp Integration

- [ ] **Configure Webhook in Meta Business Manager**
  1. Go to https://business.facebook.com
  2. Navigate to WhatsApp â†’ Configuration â†’ Webhook
  3. Callback URL: `https://gp-bikes.onrender.com/webhooks/whatsapp`
  4. Verify Token: (value from `WHATSAPP_WEBHOOK_VERIFY_TOKEN`)
  5. Subscribe to events: `messages`, `message_status`

- [ ] **Test Webhook Verification**
  ```bash
  # Meta will send a GET request to verify webhook
  # Check logs for: "WhatsApp webhook verified successfully"
  render logs gp-bikes-web --search "webhook verified"
  ```

- [ ] **Send Test WhatsApp Message**
  - Send message to GP Bikes WhatsApp number
  - Check Chatwoot dashboard for new conversation
  - Check Sidekiq for processed jobs
  - Verify AI worker responded within 2 seconds

- [ ] **Verify AI Worker Activation**
  ```bash
  # Check logs for AI worker triggers
  render logs gp-bikes-worker --search "GreetingWorker"
  # Should see: "GreetingWorker triggered for conversation #1"
  ```

---

## ðŸ“Š Monitoring Setup

### âœ… Render Dashboard Alerts

- [ ] **Configure Email Alerts**
  - Dashboard â†’ Account Settings â†’ Notifications
  - Enable: "Service down", "Deployment failed", "High memory usage"

- [ ] **Configure Slack Alerts (Optional)**
  - Dashboard â†’ Integrations â†’ Slack
  - Connect workspace
  - Select channel: `#gp-bikes-alerts`

- [ ] **Set Up Custom Alerts**
  - Service â†’ Alerts â†’ New Alert
  - **High Error Rate:** error_rate > 5% for 5 minutes
  - **High Memory:** memory > 90% for 10 minutes
  - **Service Unavailable:** health_check_failed for 2 minutes

---

### âœ… Sentry Configuration

- [ ] **Verify Error Tracking**
  - Trigger test error: `render ssh gp-bikes-web`
  - `bundle exec rails runner 'raise "Test error for Sentry"'`
  - Check Sentry dashboard for error event

- [ ] **Configure Alerts**
  - Sentry â†’ Project Settings â†’ Alerts
  - **New Issue:** Notify immediately
  - **Regressions:** Notify immediately
  - **High Volume:** > 100 errors/hour

- [ ] **Set Up Performance Monitoring**
  - Sentry â†’ Performance
  - Verify transactions are being captured
  - Check for slow transactions (> 5 seconds)

---

## ðŸŽ¯ Post-Deployment Tasks

### Week 1: Monitoring & Optimization

- [ ] **Monitor Resource Usage**
  - Day 1: CPU, memory, disk usage
  - Day 3: Check for memory leaks
  - Day 7: Review cost dashboard

- [ ] **Check OpenAI API Costs**
  - OpenAI Dashboard â†’ Usage
  - Verify spending is within budget ($100/month)
  - Set up billing alerts

- [ ] **Review Error Logs**
  - Sentry: Check for repeated errors
  - Render Logs: Check for warnings
  - Fix critical issues immediately

- [ ] **Optimize Database Queries**
  - Enable APM (Datadog/New Relic - optional)
  - Identify N+1 queries
  - Add database indexes if needed

- [ ] **Load Testing**
  ```bash
  # Install k6 (load testing tool)
  brew install k6  # macOS
  
  # Run load test (100 users for 1 minute)
  k6 run --vus 100 --duration 1m load-test.js
  ```

---

### Week 2: Feature Validation

- [ ] **Test All 8 AI Workers**
  - [ ] GreetingWorker (first message)
  - [ ] LeadQualificationWorker (detects intent)
  - [ ] ProductCatalogWorker (recommends motos)
  - [ ] ServiceSchedulingWorker (books appointments)
  - [ ] FinancingWorker (calculates payments)
  - [ ] FollowUpWorker (scheduled jobs)
  - [ ] UpsellingWorker (post-purchase)
  - [ ] PostSaleWorker (satisfaction surveys)

- [ ] **Verify Scheduled Jobs**
  - Sidekiq â†’ Cron
  - Check: FollowUpWorker runs daily at 10am COT
  - Check: HousekeepingJob runs nightly

- [ ] **Test Handoff to Human Agents**
  - Send message with "hablar con un agente"
  - Verify conversation is assigned to team
  - Check lead score is calculated correctly

---

### Month 1: Business Metrics

- [ ] **Track KPIs**
  - Automation Rate: 80%+ target
  - Average Response Time: < 2 seconds
  - Lead Qualification Accuracy: 85%+
  - Customer Satisfaction: 4.5/5 stars

- [ ] **Review Financials**
  - Render: $180/month (expected)
  - OpenAI API: $50-100/month (expected)
  - S3: $5-10/month (expected)
  - Total: $235-290/month

- [ ] **Plan Scaling Strategy**
  - If MAU > 2000: Upgrade Redis to Standard (1GB)
  - If MAU > 5000: Scale web to 4 instances
  - If MAU > 10000: Upgrade PostgreSQL to Pro Plus (32GB)

---

## ðŸš¨ Rollback Procedure

### If Deployment Fails

- [ ] **Option 1: Rollback in Render Dashboard**
  1. Dashboard â†’ Services â†’ `gp-bikes-web`
  2. Deployments â†’ Previous Deployment â†’ "Rollback"
  3. Confirm rollback

- [ ] **Option 2: Git Revert**
  ```bash
  git revert HEAD
  git push origin production
  # Render auto-deploys previous version
  ```

- [ ] **Option 3: Manual Rollback** (emergency)
  ```bash
  # Temporarily disable services
  render services suspend gp-bikes-web
  render services suspend gp-bikes-worker
  
  # Fix issues in Git
  git checkout <previous-working-commit>
  git push origin production --force
  
  # Re-enable services
  render services resume gp-bikes-web
  render services resume gp-bikes-worker
  ```

---

## ðŸ“ž Support Contacts

### Render Support
- **Dashboard:** https://dashboard.render.com
- **Community:** https://community.render.com
- **Docs:** https://render.com/docs
- **Status:** https://status.render.com

### GP Bikes Team
- **DevOps Lead:** @jorge (infrastructure questions)
- **Backend Lead:** @bolivar (Rails, AI workers)
- **Frontend Lead:** @catalina (Vue.js, dashboard)
- **Product Owner:** @daniela (requirements, priorities)

---

## âœ… Final Checklist

Before marking deployment as "complete":

- [ ] All services running and healthy
- [ ] Health check endpoint returns 200 OK
- [ ] Database migrations applied successfully
- [ ] S3 uploads working
- [ ] WhatsApp webhook receiving messages
- [ ] AI workers responding to messages
- [ ] Sidekiq processing jobs
- [ ] No critical errors in logs
- [ ] Sentry receiving events
- [ ] Monitoring alerts configured
- [ ] Team trained on Render dashboard
- [ ] Rollback procedure tested
- [ ] Documentation updated with production URLs
- [ ] Cost dashboard reviewed

---

## ðŸŽ‰ Congratulations!

Your GP Bikes AI Assistant is now **live in production** on Render! ðŸš€

**Next Steps:**
1. Monitor closely for first 48 hours
2. Gather user feedback
3. Iterate on AI worker prompts
4. Scale as traffic grows

**Remember:**
- Check Sentry daily for first week
- Review Render metrics dashboard weekly
- OpenAI API costs monthly
- Database backups are automatic (Render handles this)

**Questions?** Contact the team or refer to `/docs/setup/render-deployment-architecture.md`


