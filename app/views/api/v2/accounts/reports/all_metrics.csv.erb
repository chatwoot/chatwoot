<%
require 'csv'

def meaningful_keys(rows, field)
  rows
    .flat_map { |r| r[field]&.select { |_, v| v.present? }&.keys || [] }
    .uniq
    .sort
end

max_agents = @report_data.map { |r| r[:agents].size }.max || 0
max_labels = @report_data.map { |r| r[:labels].size }.max || 0

all_chat_custom_attrs     = meaningful_keys(@report_data, :custom_attributes)
all_contact_custom_attrs  = meaningful_keys(@report_data, :contact_custom_attributes)
all_contact_attrs         = meaningful_keys(@report_data, :contact_additional_attributes)

headers = []
headers << 'ID чата'
headers << 'Дата и время начала'
headers << 'Источник'
headers << 'Группа'
headers << 'Почта клиента'

max_agents.times do |i|
  headers << "Ник оператора #{i + 1}"
end

headers << 'Продолжительность (сек)'
headers << 'Время первого ответа (сек)'
headers << 'Среднее время ответа (сек)'
headers << 'Оценка чата (CSAT)'
headers << 'Комментарий к оценке'

max_labels.times do |i|
  headers << "Категория #{i + 1}"
end

headers << 'Имя клиента'

all_chat_custom_attrs.each do |attr|
  headers << "Chat custom: #{attr}"
end

all_contact_custom_attrs.each do |attr|
  headers << "Contact custom: #{attr}"
end

all_contact_attrs.each do |attr|
  headers << "Contact additional: #{attr}"
end

csv_options = {
  col_sep: ';',
  encoding: 'UTF-8'
}
%>

<%== CSV.generate_line(headers, **csv_options) %>

<% @report_data.each do |row| %>
<%== CSV.generate_line(
  [
    row[:conversation_id].to_s,
    row[:created_at]&.strftime('%Y-%m-%d %H:%M:%S').to_s,
    row[:inbox_name].to_s,
    row[:team_name].to_s,
    row[:contact_email].to_s,

    *Array.new(max_agents) { |i| row[:agents][i].to_s },

    row[:duration].to_s,
    row[:first_response_time].to_s,
    row[:avg_response_time].to_s,
    row[:csat_score].to_s,
    row[:csat_feedback].to_s,

    *Array.new(max_labels) { |i| row[:labels][i].to_s },

    row[:contact_name].to_s,

    *all_chat_custom_attrs.map    { |attr| row[:custom_attributes]&.[](attr).to_s },
    *all_contact_custom_attrs.map { |attr| row[:contact_custom_attributes]&.[](attr).to_s },
    *all_contact_attrs.map        { |attr| row[:contact_additional_attributes]&.[](attr).to_s }
  ],
  **csv_options
) %>
<% end %>
