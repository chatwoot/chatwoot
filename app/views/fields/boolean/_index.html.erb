<% if field.attribute == :active_chat_limit_enabled %>
  <input
    type="checkbox"
    <%= 'checked' if field.data %>
    data-id="<%= field.resource.id %>"
    data-turbo="false"
    class="limit-enabled-checkbox"
    style="cursor: pointer;"
  />
<% else %>
  <%= field.data? ? "true" : "false" %>
<% end %>

<script>
  (function() {
    function setupCheckboxHandlers() {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

      document.querySelectorAll('.limit-enabled-checkbox').forEach(cb => {
        if (cb.dataset.bound) return;
        cb.dataset.bound = '1';

        cb.addEventListener('click', e => e.stopPropagation());
        cb.addEventListener('change', async (e) => {
          const id = e.target.dataset.id;
          const enabled = e.target.checked;

          try {
            const res = await fetch(`/super_admin/account_users/${id}`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
              },
              body: JSON.stringify({ account_user: { active_chat_limit_enabled: enabled } })
            });

            if (!res.ok) throw new Error(await res.text());
            console.log(` Updated active_chat_limit_enabled for AccountUser #${id} to ${enabled}`);
          } catch (err) {
            console.error(' Error updating checkbox:', err);
            alert('Error updating checkbox');
          }
        });
      });
    }

    document.addEventListener('turbo:load', setupCheckboxHandlers);
    document.addEventListener('DOMContentLoaded', setupCheckboxHandlers);
  })();
</script>
