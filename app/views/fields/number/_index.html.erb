<% if field.attribute == :active_chat_limit %>
  <input
    type="number"
    value="<%= field.data || 0 %>"
    min="0"
    data-id="<%= field.resource.id %>"
    data-turbo="false"
    class="limit-input"
    style="width: 70px; text-align: center; cursor: text;"
  />
<% else %>
  <%= field.data %>
<% end %>

<script>
  (function() {
    function setupLimitHandlers() {
      const csrfMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfToken = csrfMeta ? csrfMeta.content : '';

      document.addEventListener('click', (e) => {
        const row = e.target.closest('tr[data-url]');
        const input = e.target.closest('.limit-input');
        if (row && input) {
          e.stopPropagation();
        }
      }, true);

      function bindInputs() {
        document.querySelectorAll('.limit-input').forEach(input => {
          if (input.dataset.bound) return;
          input.dataset.bound = "1";

          input.addEventListener('click', e => e.stopPropagation());
          input.addEventListener('focus', e => e.stopPropagation());
          input.addEventListener('keydown', e => e.stopPropagation());

          input.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            const value = e.target.value;

            try {
              const res = await fetch(`/super_admin/account_users/${id}`, {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRF-Token": csrfToken
                },
                body: JSON.stringify({ account_user: { active_chat_limit: value } })
              });

              if (!res.ok) throw new Error(await res.text());
              console.log(`Updated limit for AccountUser #${id} to ${value}`);
            } catch (err) {
              console.error("Error updating limit:", err);
              alert("Error updating limit");
            }
          });
        });
      }

      document.addEventListener('turbo:load', bindInputs);
      document.addEventListener('DOMContentLoaded', bindInputs);
      bindInputs();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupLimitHandlers);
    } else {
      setupLimitHandlers();
    }
  })();
</script>
