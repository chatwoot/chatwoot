<div class="field-unit field-unit--string">
  <%= f.label field.attribute, class: "field-unit__label" %>
  <div class="field-unit__field">
    <% if field.array? %>
      <% existing_values = field.data.presence || [{}] %>
      <% existing_values.each_with_index do |sub_field, index| %>
        <%= f.fields_for "#{field.attribute}[#{index}]", field.resource do |values_form| %>
          <div class="field-unit">
            <% sub_field.each do |sf_key, sf_value| %>
              <%= values_form.label sf_key %>
              <%= values_form.text_field sf_key, value: sf_value, name: "#{f.object_name}[#{field.attribute}][#{index}][#{sf_key}]" %>
            <% end %>
          </div>
        <% end %>
      <% end %>
    <% else %>
      <%= f.text_field field.attribute %>
    <% end %>
  </div>
</div>

