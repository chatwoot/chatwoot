version: 2.1
executors:
  xlarge-executor:
    machine:
      image: ubuntu-2004:2024.11.1
    resource_class: xlarge
orbs:
  aws-cli: circleci/aws-cli@4.1.3
  aws-eks: circleci/aws-eks@2.2.0
  aws-ecr: circleci/aws-ecr@9.0.2
  kubernetes: circleci/kubernetes@1.3.0

jobs:
  deploy-sidekiq:
    circleci_ip_ranges: false
    docker:
      - image: 'cimg/python:3.10'
    resource_class: << parameters.resource_class >>
    parameters:
      resource_class: 
        description: |
          deploy to resource class
        type: string
      cluster-name:
        description: |
          Devnet cluster
        type: string
      docker-image-name:
        description: |
          api-gateway
        type: string
      version-info:
        description: |
          Latest
        type: string
      min-replicas:
        description: |
          number of min replicas to create
        type: string
      max-replicas:
        description: |
          number of max replicas to create
        type: string
      aws-region:
        description: |
          AWS region
        type: string
        default: 'eu-west-1'
      env-name:
        description: |
          env name for managing cluster host file
        type: string
      total_cpu:
        description: |
          total cpu alloction
        type: string
      request_cpu:
        description: |
          reqests cpu alloction
        type: string
      limit_memory:
        description: |
          limit memory allocation
        type: string
      request_memory:
        description: |
          reqests memory alloction
        type: string
      secret-name:
        description: |
          secret name for managing cluster host file
        type: string
      deployment-name:
        description: |
          deploy name for managing cluster host file
        type: string
      app-name:
        description: |
          app name for managing cluster host file
        type: string
    steps:
      - checkout
      - run:
          name: Create deployment manifest
          command: |
            BUILD_DATE=$(date '+%Y%m%d%H%M%S')
            cat kubernetes/deployment-template-sidekiq.yml |\
                sed "s|DOCKER_IMAGE_NAME|<< parameters.docker-image-name >>|g;\
                s|ENV_NAME|<< parameters.env-name >>|g;\
                s|BUILD_DATE_VALUE|$BUILD_DATE|g;\
                s|MIN_REPLICAS|<< parameters.min-replicas >>|g;\
                s|MAX_REPLICAS|<< parameters.max-replicas >>|g;\
                s|TOTAL_CPU|<< parameters.total_cpu >>|g;\
                s|REQUEST_CPU|<< parameters.request_cpu >>|g;\
                s|REQUEST_MEMORY|<< parameters.request_memory >>|g;\
                s|LIMIT_MEMORY|<< parameters.limit_memory >>|g;\
                s|SECRET_NAME|<< parameters.secret-name >>|g; \
                s|DEPLOYMENT_NAME|<< parameters.deployment-name >>|g;\
                s|APP_NAME|<< parameters.app-name >>|g;\
                s|VERSION_INFO_VALUE|<< parameters.version-info >>|g;" > kubernetes/deployment.yml
      - aws-eks/update-kubeconfig-with-authenticator:
          cluster-name: << parameters.cluster-name >>
          install-kubectl: true
          aws-region: << parameters.aws-region >>
      - kubernetes/create-or-update-resource:
          resource-file-path: 'kubernetes/deployment.yml'
          namespace: chatwoot
          get-rollout-status: true
          resource-name: deployment/<< parameters.deployment-name >>

  deploy-rails:
    circleci_ip_ranges: false
    docker:
      - image: 'cimg/python:3.10'
    resource_class: << parameters.resource_class >>
    parameters:
      resource_class: 
        description: |
          deploy to resource class
        type: string
      cluster-name:
        description: |
          Devnet cluster
        type: string
      docker-image-name:
        description: |
          api-gateway
        type: string
      version-info:
        description: |
          Latest
        type: string
      min-replicas:
        description: |
          number of min replicas to create
        type: string
      max-replicas:
        description: |
          number of max replicas to create
        type: string
      aws-region:
        description: |
          AWS region
        type: string
        default: 'eu-west-1'
      env-name:
        description: |
          env name for managing cluster host file
        type: string
      total_cpu:
        description: |
          total cpu alloction
        type: string
      request_cpu:
        description: |
          reqests cpu alloction
        type: string
      limit_memory:
        description: |
          limit memory allocation
        type: string
      request_memory:
        description: |
          reqests memory alloction
        type: string
      secret-name:
        description: |
          secret name for managing cluster host file
        type: string
      deployment-name:
        description: |
          deploy name for managing cluster host file
        type: string
      app-name:
        description: |
          app name for managing cluster host file
        type: string
      service-account:
        description: |
          service account name for managing cluster host file
        type: string
    steps:
      - checkout
      - run:
          name: Create deployment manifest
          command: |
            BUILD_DATE=$(date '+%Y%m%d%H%M%S')
            cat kubernetes/deployment-template-rails.yml |\
                sed "s|DOCKER_IMAGE_NAME|<< parameters.docker-image-name >>|g;\
                s|ENV_NAME|<< parameters.env-name >>|g;\
                s|BUILD_DATE_VALUE|$BUILD_DATE|g;\
                s|MIN_REPLICAS|<< parameters.min-replicas >>|g;\
                s|MAX_REPLICAS|<< parameters.max-replicas >>|g;\
                s|TOTAL_CPU|<< parameters.total_cpu >>|g;\
                s|REQUEST_CPU|<< parameters.request_cpu >>|g;\
                s|REQUEST_MEMORY|<< parameters.request_memory >>|g;\
                s|LIMIT_MEMORY|<< parameters.limit_memory >>|g;\
                s|SECRET_NAME|<< parameters.secret-name >>|g; \
                s|DEPLOYMENT_NAME|<< parameters.deployment-name >>|g;\
                s|APP_NAME|<< parameters.app-name >>|g;\
                s|SERVICE_ACCOUNT|<< parameters.service-account >>|g;\
                s|VERSION_INFO_VALUE|<< parameters.version-info >>|g;" > kubernetes/deployment.yml
      - aws-eks/update-kubeconfig-with-authenticator:
          cluster-name: << parameters.cluster-name >>
          install-kubectl: true
          aws-region: << parameters.aws-region >>
      - kubernetes/create-or-update-resource:
          resource-file-path: 'kubernetes/deployment.yml'
          namespace: chatwoot
          get-rollout-status: true
          resource-name: deployment/<< parameters.deployment-name >>
   
workflows:
  build-and-deploy:
    jobs:
      # Build staging environment images with current codebase
      - aws-ecr/build_and_push_image:
          name: staging-build-rails
          auth:
            - aws-cli/setup:
                role_arn: "${AWS_ROLE_ARN}"
                profile_name: deltaexchange-oidc
          context: staging
          executor: xlarge-executor
          filters:
            branches:
              only:
                - develop
                - fix_hpa
          region: "${AWS_REGION}"
          account_id: ${AWS_ACCOUNT_ID}
          create_repo: true
          dockerfile: Dockerfile-staging-rails
          extra_build_args: |
            --cache-from type=registry,ref=${AWS_TOKYO_ECR_URL}/chatwoot:cache-rails
            --cache-to type=registry,ref=${AWS_TOKYO_ECR_URL}/chatwoot:cache-rails,mode=max
            --build-arg BUILDKIT_INLINE_CACHE=1
            --build-arg BUNDLE_JOBS=4
          no_output_timeout: 30m
          profile_name: deltaexchange-oidc
          repo: chatwoot
          tag: rails-${CIRCLE_SHA1}

      - aws-ecr/build_and_push_image:
          name: staging-build-sidekiq
          auth:
            - aws-cli/setup:
                role_arn: "${AWS_ROLE_ARN}"
                profile_name: deltaexchange-oidc
          context: staging
          executor: xlarge-executor
          filters:
            branches:
              only:
                - develop
                - fix_hpa
          region: "${AWS_REGION}"
          account_id: ${AWS_ACCOUNT_ID}
          create_repo: true
          dockerfile: Dockerfile-staging-sidekiq
          extra_build_args: |
            --cache-from type=registry,ref=${AWS_TOKYO_ECR_URL}/chatwoot:cache-sidekiq
            --cache-to type=registry,ref=${AWS_TOKYO_ECR_URL}/chatwoot:cache-sidekiq,mode=max
            --build-arg BUILDKIT_INLINE_CACHE=1
            --build-arg BUNDLE_JOBS=4
          no_output_timeout: 30m
          profile_name: deltaexchange-oidc
          repo: chatwoot
          tag: sidekiq-${CIRCLE_SHA1}
      
      # Build production environment chatwoot rails image with current codebase
      - aws-ecr/build_and_push_image:
          name: prod-ind-build-rails
          auth:
            - aws-cli/setup:
                role_arn: "${AWS_ROLE_ARN}"
                profile_name: deltaexchange-oidc
          context: prod-india
          executor: xlarge-executor
          filters:
            branches:
              only:
                - main
          region: "${AWS_REGION}"
          account_id: ${AWS_IND_ACCOUNT}
          create_repo: true
          dockerfile: Dockerfile-prod-ind-rails
          extra_build_args: |
            --cache-from type=registry,ref=${AWS_INDIA_ECR_URL}/chatwoot:cache-rails
            --cache-to type=registry,ref=${AWS_INDIA_ECR_URL}/chatwoot:cache-rails,mode=max
            --build-arg BUILDKIT_INLINE_CACHE=1
            --build-arg BUNDLE_JOBS=4
          no_output_timeout: 30m
          profile_name: deltaexchange-oidc
          repo: chatwoot
          tag: rails-${CIRCLE_SHA1}

      - aws-ecr/build_and_push_image:
          name: prod-ind-build-sidekiq
          auth:
            - aws-cli/setup:
                role_arn: "${AWS_ROLE_ARN}"
                profile_name: deltaexchange-oidc
          context: prod-india
          executor: xlarge-executor
          filters:
            branches:
              only:
                - main
          region: "${AWS_REGION}"
          account_id: ${AWS_IND_ACCOUNT}
          create_repo: true
          dockerfile: Dockerfile-prod-ind-sidekiq
          extra_build_args: |
            --cache-from type=registry,ref=${AWS_INDIA_ECR_URL}/chatwoot:cache-sidekiq
            --cache-to type=registry,ref=${AWS_INDIA_ECR_URL}/chatwoot:cache-sidekiq,mode=max
            --build-arg BUILDKIT_INLINE_CACHE=1
          no_output_timeout: 30m
          profile_name: deltaexchange-oidc
          repo: chatwoot
          tag: sidekiq-${CIRCLE_SHA1}

      # Devnet Sidekiq Deployment
      - deploy-sidekiq:
          name: devnet-india-sidekiq
          context: staging-v2
          resource_class: delta-exchange/deploy-devnet
          filters:
            branches:
              only:
                - develop
                - fix_hpa
          cluster-name: devnet-delta-exchange
          min-replicas: '2'
          max-replicas: '3'
          env-name: devnet
          app-name: devnet-sidekiq
          secret-name: devnet-ind-sidekiq
          aws-region: $AWS_REGION
          docker-image-name: '${AWS_TOKYO_ECR_URL}/chatwoot:sidekiq-${CIRCLE_SHA1}'
          version-info: ${CIRCLE_SHA1}
          total_cpu: '0.5'
          request_cpu: '0.2'
          limit_memory: '512M'
          request_memory: '256M'
          deployment-name: 'staging-sidekiq'
          requires:
            - staging-build-sidekiq

      - deploy-rails:
          name: devnet-india-chatwoot-rails
          context: staging-v2
          resource_class: delta-exchange/deploy-devnet
          filters:
            branches:
              only:
                - develop
                - fix_hpa
          cluster-name: devnet-delta-exchange
          min-replicas: '2'
          max-replicas: '3'
          env-name: devnet
          app-name: devnet-chatwoot
          secret-name: devnet-ind-chatwoot
          aws-region: $AWS_REGION
          docker-image-name: '${AWS_TOKYO_ECR_URL}/chatwoot:rails-${CIRCLE_SHA1}'
          version-info: ${CIRCLE_SHA1}
          total_cpu: '1'
          request_cpu: '0.5'
          limit_memory: '1G'
          request_memory: '512M'
          deployment-name: 'staging-chatwoot'
          service-account: 'rails-sa'
          requires:
            - staging-build-rails
      
      - deploy-approval-ind-sidekiq:
          type: approval
          filters:
            branches:
              only:
                - main
          requires:
            - prod-ind-build-sidekiq

      - deploy-approval-ind-rails:
          type: approval
          filters:
            branches:
              only:
                - main
          requires:
            - prod-ind-build-rails

      # Production sidekiq deployment
      - deploy-sidekiq:
          name: prod-ind-sidekiq
          context: prod-india-v2
          resource_class: delta-exchange/deploy-india
          filters:
            branches:
              only:
                - main
          cluster-name: prod-india-exchange
          min-replicas: '5'
          max-replicas: '8'
          env-name: production
          app-name: prod-sidekiq
          secret-name: prod-ind-sidekiq
          aws-region: $AWS_REGION
          docker-image-name: '${AWS_INDIA_ECR_URL}/chatwoot:sidekiq-${CIRCLE_SHA1}'
          version-info: ${CIRCLE_SHA1}
          total_cpu: '1'
          request_cpu: '0.4'
          limit_memory: '2Gi'
          request_memory: '400M'
          deployment-name: 'prod-sidekiq'
          requires:
            - deploy-approval-ind-sidekiq

      # Production chatwoot rails deployment
      - deploy-rails:
          name: prod-ind-chatwoot-rails
          context: prod-india-v2
          resource_class: delta-exchange/deploy-india
          filters:
            branches:
              only:
                - main
          cluster-name: prod-india-exchange
          min-replicas: '8'
          max-replicas: '12'
          env-name: production
          app-name: prod-chatwoot
          secret-name: prod-ind-chatwoot
          aws-region: $AWS_REGION
          docker-image-name: '${AWS_INDIA_ECR_URL}/chatwoot:rails-${CIRCLE_SHA1}'
          version-info: ${CIRCLE_SHA1}
          total_cpu: '2'
          request_cpu: '1'
          limit_memory: '2Gi'
          request_memory: '1Gi'
          deployment-name: 'prod-chatwoot'
          service-account: 'chatwoot-rails-sa'
          requires:
            - deploy-approval-ind-rails
      