#!/bin/bash
###
set -e

REGION="ap-southeast-1"
PREFIX="/$RAILS_ENV/chatwoot"
PARAM_KEYS=(
SECRET_KEY_BASE
FRONTEND_URL
FORCE_SSL
IP_LOOKUP_API_KEY
ENABLE_ACCOUNT_SIGNUP
REDIS_URL
REDIS_PASSWORD
POSTGRES_HOST
POSTGRES_USERNAME
POSTGRES_PASSWORD
RAILS_MAX_THREADS
BLAZER_DATABASE_URL
#MAILER_SENDER_EMAIL
SMTP_DOMAIN
SMTP_ADDRESS
SMTP_PORT
SMTP_USERNAME
SMTP_PASSWORD
SMTP_AUTHENTICATION
SMTP_ENABLE_STARTTLS_AUTO
SMTP_OPENSSL_VERIFY_MODE
ACTIVE_STORAGE_SERVICE
S3_BUCKET_NAME
AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY
AWS_REGION
RAILS_LOG_TO_STDOUT
LOG_LEVEL
LOG_SIZE
FB_APP_ID
FB_APP_SECRET
FB_VERIFY_TOKEN
FACEBOOK_API_VERSION
IG_VERIFY_TOKEN
SLACK_CLIENT_ID
SLACK_CLIENT_SECRET
GOOGLE_OAUTH_CLIENT_SECRET
GOOGLE_OAUTH_CALLBACK_URL
IOS_APP_ID
ANDROID_BUNDLE_ID
ANDROID_SHA256_CERT_FINGERPRINT
ENABLE_PUSH_RELAY_SERVER
ZALO_APP_ID
ZALO_APP_SECRET
)

FULL_NAMES=()
for key in "${PARAM_KEYS[@]}"; do
  FULL_NAMES+=("$PREFIX/$key")
done

echo "# Auto-generated .env file" > /app/.env

for ((i = 0; i < ${#FULL_NAMES[@]}; i += 10)); do
  CHUNK=("${FULL_NAMES[@]:i:10}")

  RESPONSE=$(aws ssm get-parameters \
    --region "$REGION" \
    --names "${CHUNK[@]}" \
    --query 'Parameters[*].[Name,Value]' \
    --output text)

  while read -r NAME VALUE; do
    ENV_KEY=$(basename "$NAME") 
    echo "$ENV_KEY=$VALUE" >> /app/.env
  done <<< "$RESPONSE"
done
export $(grep -v '^#' /app/.env | xargs)
exec "$@"

