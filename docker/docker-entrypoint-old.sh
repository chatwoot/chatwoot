#!/bin/bash
set -e

REGION="ap-southeast-1"
PREFIX="$RAILS_ENV/chatwoot"
get_parameter() {
  aws ssm get-parameter --name $1 --region $REGION --query 'Parameter.Value' --output text
}
cat >> /app/.env << EOF
SECRET_KEY_BASE="$(get_parameter /$PREFIX/SECRET_KEY_BASE)"
FRONTEND_URL="$(get_parameter /$PREFIX/FRONTEND_URL)"
FORCE_SSL="$(get_parameter /$PREFIX/FORCE_SSL)"
IP_LOOKUP_API_KEY="$(get_parameter /$PREFIX/IP_LOOKUP_API_KEY)"
ENABLE_ACCOUNT_SIGNUP="$(get_parameter /$PREFIX/ENABLE_ACCOUNT_SIGNUP)"
REDIS_URL="$(get_parameter /$PREFIX/REDIS_URL)"
REDIS_PASSWORD="$(get_parameter /$PREFIX/REDIS_PASSWORD)"
POSTGRES_HOST="$(get_parameter /$PREFIX/POSTGRES_HOST)"
POSTGRES_USERNAME="$(get_parameter /$PREFIX/POSTGRES_USERNAME)"
POSTGRES_PASSWORD="$(get_parameter /$PREFIX/POSTGRES_PASSWORD)"
RAILS_MAX_THREADS="$(get_parameter /$PREFIX/RAILS_MAX_THREADS)"
BLAZER_DATABASE_URL="$(get_parameter /$PREFIX/BLAZER_DATABASE_URL)"
MAILER_SENDER_EMAIL="$(get_parameter /$PREFIX/MAILER_SENDER_EMAIL)"
SMTP_DOMAIN="$(get_parameter /$PREFIX/SMTP_DOMAIN)"
SMTP_ADDRESS="$(get_parameter /$PREFIX/SMTP_ADDRESS)"
SMTP_PORT="$(get_parameter /$PREFIX/SMTP_PORT)"
SMTP_USERNAME="$(get_parameter /$PREFIX/SMTP_USERNAME)"
SMTP_PASSWORD="$(get_parameter /$PREFIX/SMTP_PASSWORD)"
SMTP_AUTHENTICATION="$(get_parameter /$PREFIX/SMTP_AUTHENTICATION)"
SMTP_ENABLE_STARTTLS_AUTO="$(get_parameter /$PREFIX/SMTP_ENABLE_STARTTLS_AUTO)"
SMTP_OPENSSL_VERIFY_MODE="$(get_parameter /$PREFIX/SMTP_OPENSSL_VERIFY_MODE)"
ACTIVE_STORAGE_SERVICE="$(get_parameter /$PREFIX/ACTIVE_STORAGE_SERVICE)"
S3_BUCKET_NAME="$(get_parameter /$PREFIX/S3_BUCKET_NAME)"
AWS_ACCESS_KEY_ID="$(get_parameter /$PREFIX/AWS_ACCESS_KEY_ID)"
AWS_SECRET_ACCESS_KEY="$(get_parameter /$PREFIX/AWS_SECRET_ACCESS_KEY)"
AWS_REGION="$(get_parameter /$PREFIX/AWS_REGION)"
RAILS_LOG_TO_STDOUT="$(get_parameter /$PREFIX/RAILS_LOG_TO_STDOUT)"
LOG_LEVEL="$(get_parameter /$PREFIX/LOG_LEVEL)"
LOG_SIZE="$(get_parameter /$PREFIX/LOG_SIZE)"
FB_APP_ID="$(get_parameter /$PREFIX/FB_APP_ID)"
FB_APP_SECRET="$(get_parameter /$PREFIX/FB_APP_SECRET)"
FB_VERIFY_TOKEN="$(get_parameter /$PREFIX/FB_VERIFY_TOKEN)"
FACEBOOK_API_VERSION="$(get_parameter /$PREFIX/FACEBOOK_API_VERSION)"
IG_VERIFY_TOKEN="$(get_parameter /$PREFIX/IG_VERIFY_TOKEN)"
SLACK_CLIENT_ID="$(get_parameter /$PREFIX/SLACK_CLIENT_ID)"
SLACK_CLIENT_SECRET="$(get_parameter /$PREFIX/SLACK_CLIENT_SECRET)"
GOOGLE_OAUTH_CLIENT_SECRET="$(get_parameter /$PREFIX/GOOGLE_OAUTH_CLIENT_SECRET)"
GOOGLE_OAUTH_CALLBACK_URL="$(get_parameter /$PREFIX/GOOGLE_OAUTH_CALLBACK_URL)"
IOS_APP_ID="$(get_parameter /$PREFIX/IOS_APP_ID)"
ANDROID_BUNDLE_ID="$(get_parameter /$PREFIX/ANDROID_BUNDLE_ID)"
ANDROID_SHA256_CERT_FINGERPRINT="$(get_parameter /$PREFIX/ANDROID_SHA256_CERT_FINGERPRINT)"
ENABLE_PUSH_RELAY_SERVER="$(get_parameter /$PREFIX/ENABLE_PUSH_RELAY_SERVER)"
EOF
export $(grep -v '^#' /app/.env | xargs)

exec "$@"
