# Inherit from main Dockerfile for current codebase
FROM ruby:3.3.3-alpine3.19 AS base

ARG BUNDLE_WITHOUT="development:test"
ENV BUNDLE_WITHOUT=${BUNDLE_WITHOUT}
ENV BUNDLER_VERSION=2.5.11
ENV BUNDLE_PATH="/gems"
ENV RAILS_ENV=production

RUN apk update && apk add --no-cache \
  build-base \
  openssl \
  tzdata \
  postgresql-client \
  git \
  vips \
  && gem install bundler

WORKDIR /app

COPY Gemfile Gemfile.lock ./

RUN apk add --no-cache build-base musl ruby-full ruby-dev gcc make musl-dev openssl openssl-dev g++ linux-headers xz vips
RUN bundle config set --local force_ruby_platform true
RUN bundle config set without 'development test' && bundle install -j 4 -r 3

COPY . /app

RUN mkdir -p /app/log
RUN git rev-parse HEAD > /app/.git_sha 2>/dev/null || echo "unknown" > /app/.git_sha

RUN rm -rf /gems/ruby/3.3.0/cache/*.gem \
  && find /gems/ruby/3.3.0/gems/ \( -name "*.c" -o -name "*.o" \) -delete

EXPOSE 5151
CMD ["bundle", "exec", "sidekiq", "-C", "config/sidekiq.yml"]