# Production Rails - Inherit from main Dockerfile for current codebase
FROM ruby:3.3.3-alpine3.19 AS base

ARG BUNDLE_WITHOUT="development:test"
ENV BUNDLE_WITHOUT=${BUNDLE_WITHOUT}
ENV BUNDLER_VERSION=2.5.11
ENV BUNDLE_PATH="/gems"
ENV RAILS_ENV=production
ENV RAILS_SERVE_STATIC_FILES=true

RUN apk update && apk add --no-cache \
  build-base \
  openssl \
  tzdata \
  postgresql-client \
  imagemagick \
  git \
  vips \
  && gem install bundler

WORKDIR /app

COPY Gemfile Gemfile.lock ./

RUN apk add --no-cache build-base musl ruby-full ruby-dev gcc make musl-dev openssl openssl-dev g++ linux-headers xz vips
RUN bundle config set --local force_ruby_platform true
RUN bundle config set without 'development test' && bundle install -j 4 -r 3

COPY package.json pnpm-lock.yaml ./

COPY . /app

RUN mkdir -p /app/log /app/tmp
RUN git rev-parse HEAD > /app/.git_sha 2>/dev/null || echo "unknown" > /app/.git_sha

RUN SECRET_KEY_BASE=precompile_placeholder RAILS_LOG_TO_STDOUT=enabled bundle exec rake assets:precompile \
  && rm -rf spec node_modules tmp/cache

RUN rm -rf /gems/ruby/3.3.0/cache/*.gem \
  && find /gems/ruby/3.3.0/gems/ \( -name "*.c" -o -name "*.o" \) -delete

COPY container_init.sh /app/container_init.sh
RUN chmod +x /app/container_init.sh

EXPOSE 3001
CMD ["/app/container_init.sh"]