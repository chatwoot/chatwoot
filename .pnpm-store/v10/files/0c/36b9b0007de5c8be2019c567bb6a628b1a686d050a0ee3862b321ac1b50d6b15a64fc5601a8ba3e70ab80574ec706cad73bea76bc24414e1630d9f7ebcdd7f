{"version":3,"file":"storage.js","sourceRoot":"","sources":["../../src/storage.ts"],"names":[],"mappings":"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","sourcesContent":["import { extend } from './utils'\nimport { PersistentStore, Properties } from './types'\nimport {\n    DISTINCT_ID,\n    ENABLE_PERSON_PROCESSING,\n    INITIAL_PERSON_INFO,\n    SESSION_ID,\n    SESSION_RECORDING_IS_SAMPLED,\n} from './constants'\n\nimport { isNull, isUndefined } from '@posthog/core'\nimport { logger } from './utils/logger'\nimport { window, document } from './utils/globals'\nimport { uuidv7 } from './uuidv7'\n\n// we store the discovered subdomain in memory because it might be read multiple times\nlet firstNonPublicSubDomain = ''\n\n// helper to allow tests to clear this \"cache\"\nexport const resetSubDomainCache = () => {\n    firstNonPublicSubDomain = ''\n}\n\n/**\n * Browsers don't offer a way to check if something is a public suffix\n * e.g. `.com.au`, `.io`, `.org.uk`\n *\n * But they do reject cookies set on public suffixes\n * Setting a cookie on `.co.uk` would mean it was sent for every `.co.uk` site visited\n *\n * So, we can use this to check if a domain is a public suffix\n * by trying to set a cookie on a subdomain of the provided hostname\n * until the browser accepts it\n *\n * inspired by https://github.com/AngusFu/browser-root-domain\n */\nexport function seekFirstNonPublicSubDomain(hostname: string, cookieJar = document): string {\n    if (firstNonPublicSubDomain) {\n        return firstNonPublicSubDomain\n    }\n\n    if (!cookieJar) {\n        return ''\n    }\n    if (['localhost', '127.0.0.1'].includes(hostname)) return ''\n\n    const list = hostname.split('.')\n    let len = Math.min(list.length, 8) // paranoia - we know this number should be small\n    const key = 'dmn_chk_' + uuidv7()\n\n    while (!firstNonPublicSubDomain && len--) {\n        const candidate = list.slice(len).join('.')\n        const candidateCookieValue = key + '=1;domain=.' + candidate + ';path=/'\n\n        // try to set cookie, include a short expiry in seconds since we'll check immediately\n        cookieJar.cookie = candidateCookieValue + ';max-age=3'\n\n        if (cookieJar.cookie.includes(key)) {\n            // the cookie was accepted by the browser, remove the test cookie\n            cookieJar.cookie = candidateCookieValue + ';max-age=0'\n            firstNonPublicSubDomain = candidate\n        }\n    }\n\n    return firstNonPublicSubDomain\n}\n\nconst DOMAIN_MATCH_REGEX = /[a-z0-9][a-z0-9-]+\\.[a-z]{2,}$/i\nconst originalCookieDomainFn = (hostname: string): string => {\n    const matches = hostname.match(DOMAIN_MATCH_REGEX)\n    return matches ? matches[0] : ''\n}\n\nexport function chooseCookieDomain(hostname: string, cross_subdomain: boolean | undefined): string {\n    if (cross_subdomain) {\n        // NOTE: Could we use this for cross domain tracking?\n        let matchedSubDomain = seekFirstNonPublicSubDomain(hostname)\n\n        if (!matchedSubDomain) {\n            const originalMatch = originalCookieDomainFn(hostname)\n            if (originalMatch !== matchedSubDomain) {\n                logger.info('Warning: cookie subdomain discovery mismatch', originalMatch, matchedSubDomain)\n            }\n            matchedSubDomain = originalMatch\n        }\n\n        return matchedSubDomain ? '; domain=.' + matchedSubDomain : ''\n    }\n    return ''\n}\n\n// Methods partially borrowed from quirksmode.org/js/cookies.html\nexport const cookieStore: PersistentStore = {\n    _is_supported: () => !!document,\n\n    _error: function (msg) {\n        logger.error('cookieStore error: ' + msg)\n    },\n\n    _get: function (name) {\n        if (!document) {\n            return\n        }\n\n        try {\n            const nameEQ = name + '='\n            const ca = document.cookie.split(';').filter((x) => x.length)\n            for (let i = 0; i < ca.length; i++) {\n                let c = ca[i]\n                while (c.charAt(0) == ' ') {\n                    c = c.substring(1, c.length)\n                }\n                if (c.indexOf(nameEQ) === 0) {\n                    return decodeURIComponent(c.substring(nameEQ.length, c.length))\n                }\n            }\n        } catch {}\n        return null\n    },\n\n    _parse: function (name) {\n        let cookie\n        try {\n            cookie = JSON.parse(cookieStore._get(name)) || {}\n        } catch {\n            // noop\n        }\n        return cookie\n    },\n\n    _set: function (name, value, days, cross_subdomain, is_secure) {\n        if (!document) {\n            return\n        }\n        try {\n            let expires = '',\n                secure = ''\n\n            const cdomain = chooseCookieDomain(document.location.hostname, cross_subdomain)\n\n            if (days) {\n                const date = new Date()\n                date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000)\n                expires = '; expires=' + date.toUTCString()\n            }\n\n            if (is_secure) {\n                secure = '; secure'\n            }\n\n            const new_cookie_val =\n                name +\n                '=' +\n                encodeURIComponent(JSON.stringify(value)) +\n                expires +\n                '; SameSite=Lax; path=/' +\n                cdomain +\n                secure\n\n            // 4096 bytes is the size at which some browsers (e.g. firefox) will not store a cookie, warn slightly before that\n            if (new_cookie_val.length > 4096 * 0.9) {\n                logger.warn('cookieStore warning: large cookie, len=' + new_cookie_val.length)\n            }\n\n            document.cookie = new_cookie_val\n            return new_cookie_val\n        } catch {\n            return\n        }\n    },\n\n    _remove: function (name, cross_subdomain) {\n        if (!document?.cookie) {\n            return\n        }\n        try {\n            cookieStore._set(name, '', -1, cross_subdomain)\n        } catch {\n            return\n        }\n    },\n}\n\nlet _localStorage_supported: boolean | null = null\nexport const resetLocalStorageSupported = () => {\n    _localStorage_supported = null\n}\n\nexport const localStore: PersistentStore = {\n    _is_supported: function () {\n        if (!isNull(_localStorage_supported)) {\n            return _localStorage_supported\n        }\n\n        let supported = true\n        if (!isUndefined(window)) {\n            try {\n                const key = '__mplssupport__',\n                    val = 'xyz'\n                localStore._set(key, val)\n                if (localStore._get(key) !== '\"xyz\"') {\n                    supported = false\n                }\n                localStore._remove(key)\n            } catch {\n                supported = false\n            }\n        } else {\n            supported = false\n        }\n        if (!supported) {\n            logger.error('localStorage unsupported; falling back to cookie store')\n        }\n\n        _localStorage_supported = supported\n        return supported\n    },\n\n    _error: function (msg) {\n        logger.error('localStorage error: ' + msg)\n    },\n\n    _get: function (name) {\n        try {\n            return window?.localStorage.getItem(name)\n        } catch (err) {\n            localStore._error(err)\n        }\n        return null\n    },\n\n    _parse: function (name) {\n        try {\n            return JSON.parse(localStore._get(name)) || {}\n        } catch {\n            // noop\n        }\n        return null\n    },\n\n    _set: function (name, value) {\n        try {\n            window?.localStorage.setItem(name, JSON.stringify(value))\n        } catch (err) {\n            localStore._error(err)\n        }\n    },\n\n    _remove: function (name) {\n        try {\n            window?.localStorage.removeItem(name)\n        } catch (err) {\n            localStore._error(err)\n        }\n    },\n}\n\n// Use localstorage for most data but still use cookie for COOKIE_PERSISTED_PROPERTIES\n// This solves issues with cookies having too much data in them causing headers too large\n// Also makes sure we don't have to send a ton of data to the server\nconst COOKIE_PERSISTED_PROPERTIES = [\n    DISTINCT_ID,\n    SESSION_ID,\n    SESSION_RECORDING_IS_SAMPLED,\n    ENABLE_PERSON_PROCESSING,\n    INITIAL_PERSON_INFO,\n]\n\nexport const localPlusCookieStore: PersistentStore = {\n    ...localStore,\n    _parse: function (name) {\n        try {\n            let cookieProperties: Properties = {}\n            try {\n                // See if there's a cookie stored with data.\n                cookieProperties = cookieStore._parse(name) || {}\n            } catch {}\n            const value = extend(cookieProperties, JSON.parse(localStore._get(name) || '{}'))\n            localStore._set(name, value)\n            return value\n        } catch {\n            // noop\n        }\n        return null\n    },\n\n    _set: function (name, value, days, cross_subdomain, is_secure, debug) {\n        try {\n            localStore._set(name, value, undefined, undefined, debug)\n            const cookiePersistedProperties: Record<string, any> = {}\n            COOKIE_PERSISTED_PROPERTIES.forEach((key) => {\n                if (value[key]) {\n                    cookiePersistedProperties[key] = value[key]\n                }\n            })\n\n            if (Object.keys(cookiePersistedProperties).length) {\n                cookieStore._set(name, cookiePersistedProperties, days, cross_subdomain, is_secure, debug)\n            }\n        } catch (err) {\n            localStore._error(err)\n        }\n    },\n\n    _remove: function (name, cross_subdomain) {\n        try {\n            window?.localStorage.removeItem(name)\n            cookieStore._remove(name, cross_subdomain)\n        } catch (err) {\n            localStore._error(err)\n        }\n    },\n}\n\nconst memoryStorage: Properties = {}\n\n// Storage that only lasts the length of the pageview if we don't want to use cookies\nexport const memoryStore: PersistentStore = {\n    _is_supported: function () {\n        return true\n    },\n\n    _error: function (msg) {\n        logger.error('memoryStorage error: ' + msg)\n    },\n\n    _get: function (name) {\n        return memoryStorage[name] || null\n    },\n\n    _parse: function (name) {\n        return memoryStorage[name] || null\n    },\n\n    _set: function (name, value) {\n        memoryStorage[name] = value\n    },\n\n    _remove: function (name) {\n        delete memoryStorage[name]\n    },\n}\n\nlet sessionStorageSupported: boolean | null = null\nexport const resetSessionStorageSupported = () => {\n    sessionStorageSupported = null\n}\n// Storage that only lasts the length of a tab/window. Survives page refreshes\nexport const sessionStore: PersistentStore = {\n    _is_supported: function () {\n        if (!isNull(sessionStorageSupported)) {\n            return sessionStorageSupported\n        }\n        sessionStorageSupported = true\n        if (!isUndefined(window)) {\n            try {\n                const key = '__support__',\n                    val = 'xyz'\n                sessionStore._set(key, val)\n                if (sessionStore._get(key) !== '\"xyz\"') {\n                    sessionStorageSupported = false\n                }\n                sessionStore._remove(key)\n            } catch {\n                sessionStorageSupported = false\n            }\n        } else {\n            sessionStorageSupported = false\n        }\n        return sessionStorageSupported\n    },\n\n    _error: function (msg) {\n        logger.error('sessionStorage error: ', msg)\n    },\n\n    _get: function (name) {\n        try {\n            return window?.sessionStorage.getItem(name)\n        } catch (err) {\n            sessionStore._error(err)\n        }\n        return null\n    },\n\n    _parse: function (name) {\n        try {\n            return JSON.parse(sessionStore._get(name)) || null\n        } catch {\n            // noop\n        }\n        return null\n    },\n\n    _set: function (name, value) {\n        try {\n            window?.sessionStorage.setItem(name, JSON.stringify(value))\n        } catch (err) {\n            sessionStore._error(err)\n        }\n    },\n\n    _remove: function (name) {\n        try {\n            window?.sessionStorage.removeItem(name)\n        } catch (err) {\n            sessionStore._error(err)\n        }\n    },\n}\n"]}