{"version":3,"file":"onTTFB.js","sources":["../../../../src/metrics/web-vitals/onTTFB.ts"],"sourcesContent":["/*\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { WINDOW } from '../../types';\nimport { bindReporter } from './lib/bindReporter';\nimport { getActivationStart } from './lib/getActivationStart';\nimport { getNavigationEntry } from './lib/getNavigationEntry';\nimport { initMetric } from './lib/initMetric';\nimport { whenActivated } from './lib/whenActivated';\nimport type { MetricRatingThresholds, ReportOpts, TTFBReportCallback } from './types';\n\n/** Thresholds for TTFB. See https://web.dev/articles/ttfb#what_is_a_good_ttfb_score */\nexport const TTFBThresholds: MetricRatingThresholds = [800, 1800];\n\n/**\n * Runs in the next task after the page is done loading and/or prerendering.\n * @param callback\n */\nconst whenReady = (callback: () => void) => {\n  if (WINDOW.document && WINDOW.document.prerendering) {\n    whenActivated(() => whenReady(callback));\n  } else if (WINDOW.document && WINDOW.document.readyState !== 'complete') {\n    addEventListener('load', () => whenReady(callback), true);\n  } else {\n    // Queue a task so the callback runs after `loadEventEnd`.\n    setTimeout(callback, 0);\n  }\n};\n\n/**\n * Calculates the [TTFB](https://web.dev/articles/ttfb) value for the\n * current page and calls the `callback` function once the page has loaded,\n * along with the relevant `navigation` performance entry used to determine the\n * value. The reported value is a `DOMHighResTimeStamp`.\n *\n * Note, this function waits until after the page is loaded to call `callback`\n * in order to ensure all properties of the `navigation` entry are populated.\n * This is useful if you want to report on other metrics exposed by the\n * [Navigation Timing API](https://w3c.github.io/navigation-timing/). For\n * example, the TTFB metric starts from the page's [time\n * origin](https://www.w3.org/TR/hr-time-2/#sec-time-origin), which means it\n * includes time spent on DNS lookup, connection negotiation, network latency,\n * and server processing time.\n */\nexport const onTTFB = (onReport: TTFBReportCallback, opts: ReportOpts = {}) => {\n  const metric = initMetric('TTFB');\n  const report = bindReporter(onReport, metric, TTFBThresholds, opts.reportAllChanges);\n\n  whenReady(() => {\n    const navEntry = getNavigationEntry();\n\n    if (navEntry) {\n      const responseStart = navEntry.responseStart;\n\n      // In some cases no value is reported by the browser (for\n      // privacy/security reasons), and in other cases (bugs) the value is\n      // negative or is larger than the current page time. Ignore these cases:\n      // https://github.com/GoogleChrome/web-vitals/issues/137\n      // https://github.com/GoogleChrome/web-vitals/issues/162\n      // https://github.com/GoogleChrome/web-vitals/issues/275\n      if (responseStart <= 0 || responseStart > performance.now()) return;\n\n      // The activationStart reference is used because TTFB should be\n      // relative to page activation rather than navigation start if the\n      // page was prerendered. But in cases where `activationStart` occurs\n      // after the first byte is received, this time should be clamped at 0.\n      metric.value = Math.max(responseStart - getActivationStart(), 0);\n\n      metric.entries = [navEntry];\n      report(true);\n    }\n  });\n};\n"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AASA;AACO,MAAM,cAAc,GAA2B,CAAC,GAAG,EAAE,IAAI,EAAC;AACjE;AACA;AACA;AACA;AACA;AACA,MAAM,SAAU,GAAE,CAAC,QAAQ,KAAiB;AAC5C,EAAE,IAAI,MAAM,CAAC,QAAA,IAAY,MAAM,CAAC,QAAQ,CAAC,YAAY,EAAE;AACvD,IAAI,aAAa,CAAC,MAAM,SAAS,CAAC,QAAQ,CAAC,CAAC,CAAA;AAC5C,GAAI,MAAK,IAAI,MAAM,CAAC,QAAA,IAAY,MAAM,CAAC,QAAQ,CAAC,UAAW,KAAI,UAAU,EAAE;AAC3E,IAAI,gBAAgB,CAAC,MAAM,EAAE,MAAM,SAAS,CAAC,QAAQ,CAAC,EAAE,IAAI,CAAC,CAAA;AAC7D,SAAS;AACT;AACA,IAAI,UAAU,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAA;AAC3B,GAAE;AACF,CAAC,CAAA;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACa,MAAA,MAAA,GAAS,CAAC,QAAQ,EAAsB,IAAI,GAAe,EAAE,KAAK;AAC/E,EAAE,MAAM,MAAO,GAAE,UAAU,CAAC,MAAM,CAAC,CAAA;AACnC,EAAE,MAAM,MAAA,GAAS,YAAY,CAAC,QAAQ,EAAE,MAAM,EAAE,cAAc,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAA;AACtF;AACA,EAAE,SAAS,CAAC,MAAM;AAClB,IAAI,MAAM,QAAA,GAAW,kBAAkB,EAAE,CAAA;AACzC;AACA,IAAI,IAAI,QAAQ,EAAE;AAClB,MAAM,MAAM,aAAA,GAAgB,QAAQ,CAAC,aAAa,CAAA;AAClD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,IAAI,aAAc,IAAG,KAAK,aAAA,GAAgB,WAAW,CAAC,GAAG,EAAE,EAAE,OAAM;AACzE;AACA;AACA;AACA;AACA;AACA,MAAM,MAAM,CAAC,KAAM,GAAE,IAAI,CAAC,GAAG,CAAC,aAAA,GAAgB,kBAAkB,EAAE,EAAE,CAAC,CAAC,CAAA;AACtE;AACA,MAAM,MAAM,CAAC,OAAA,GAAU,CAAC,QAAQ,CAAC,CAAA;AACjC,MAAM,MAAM,CAAC,IAAI,CAAC,CAAA;AAClB,KAAI;AACJ,GAAG,CAAC,CAAA;AACJ;;;;"}