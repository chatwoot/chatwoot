{"version":3,"file":"router.js","sources":["../../src/router.ts"],"sourcesContent":["import { captureException } from '@sentry/browser';\nimport {\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  getActiveSpan,\n  getCurrentScope,\n  getRootSpan,\n  spanToJSON,\n} from '@sentry/core';\nimport type { Span, SpanAttributes, StartSpanOptions, TransactionSource } from '@sentry/types';\n\n// The following type is an intersection of the Route type from VueRouter v2, v3, and v4.\n// This is not great, but kinda necessary to make it work with all versions at the same time.\nexport type Route = {\n  /** Unparameterized URL */\n  path: string;\n  /**\n   * Query params (keys map to null when there is no value associated, e.g. \"?foo\" and to an array when there are\n   * multiple query params that have the same key, e.g. \"?foo&foo=bar\")\n   */\n  query: Record<string, string | null | (string | null)[]>;\n  /** Route name (VueRouter provides a way to give routes individual names) */\n  name?: string | symbol | null | undefined;\n  /** Evaluated parameters */\n  params: Record<string, string | string[]>;\n  /** All the matched route objects as defined in VueRouter constructor */\n  matched: { path: string }[];\n};\n\ninterface VueRouter {\n  onError: (fn: (err: Error) => void) => void;\n  beforeEach: (fn: (to: Route, from: Route, next?: () => void) => void) => void;\n}\n\n/**\n * Instrument the Vue router to create navigation spans.\n */\nexport function instrumentVueRouter(\n  router: VueRouter,\n  options: {\n    /**\n     * What to use for route labels.\n     * By default, we use route.name (if set) and else the path.\n     *\n     * Default: 'name'\n     */\n    routeLabel: 'name' | 'path';\n    instrumentPageLoad: boolean;\n    instrumentNavigation: boolean;\n  },\n  startNavigationSpanFn: (context: StartSpanOptions) => void,\n): void {\n  let isFirstPageLoad = true;\n\n  router.onError(error => captureException(error, { mechanism: { handled: false } }));\n\n  router.beforeEach((to, from, next) => {\n    // According to docs we could use `from === VueRouter.START_LOCATION` but I couldn't get it working for Vue 2\n    // https://router.vuejs.org/api/#router-start-location\n    // https://next.router.vuejs.org/api/#start-location\n    // Additionally, Nuxt does not provide the possibility to check for `from.matched.length === 0` (this is never 0).\n    // Therefore, a flag was added to track the page-load: isFirstPageLoad\n\n    // from.name:\n    // - Vue 2: null\n    // - Vue 3: undefined\n    // - Nuxt: undefined\n    // hence only '==' instead of '===', because `undefined == null` evaluates to `true`\n    const isPageLoadNavigation =\n      (from.name == null && from.matched.length === 0) || (from.name === undefined && isFirstPageLoad);\n\n    if (isFirstPageLoad) {\n      isFirstPageLoad = false;\n    }\n\n    const attributes: SpanAttributes = {\n      [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.navigation.vue',\n    };\n\n    for (const key of Object.keys(to.params)) {\n      attributes[`params.${key}`] = to.params[key];\n    }\n    for (const key of Object.keys(to.query)) {\n      const value = to.query[key];\n      if (value) {\n        attributes[`query.${key}`] = value;\n      }\n    }\n\n    // Determine a name for the routing transaction and where that name came from\n    let spanName: string = to.path;\n    let transactionSource: TransactionSource = 'url';\n    if (to.name && options.routeLabel !== 'path') {\n      spanName = to.name.toString();\n      transactionSource = 'custom';\n    } else if (to.matched.length > 0) {\n      const lastIndex = to.matched.length - 1;\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      spanName = to.matched[lastIndex]!.path;\n      transactionSource = 'route';\n    }\n\n    getCurrentScope().setTransactionName(spanName);\n\n    if (options.instrumentPageLoad && isPageLoadNavigation) {\n      const activeRootSpan = getActiveRootSpan();\n      if (activeRootSpan) {\n        const existingAttributes = spanToJSON(activeRootSpan).data || {};\n        if (existingAttributes[SEMANTIC_ATTRIBUTE_SENTRY_SOURCE] !== 'custom') {\n          activeRootSpan.updateName(spanName);\n          activeRootSpan.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_SOURCE, transactionSource);\n        }\n        // Set router attributes on the existing pageload transaction\n        // This will override the origin, and add params & query attributes\n        activeRootSpan.setAttributes({\n          ...attributes,\n          [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.pageload.vue',\n        });\n      }\n    }\n\n    if (options.instrumentNavigation && !isPageLoadNavigation) {\n      attributes[SEMANTIC_ATTRIBUTE_SENTRY_SOURCE] = transactionSource;\n      attributes[SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN] = 'auto.navigation.vue';\n      startNavigationSpanFn({\n        name: spanName,\n        op: 'navigation',\n        attributes,\n      });\n    }\n\n    // Vue Router 4 no longer exposes the `next` function, so we need to\n    // check if it's available before calling it.\n    // `next` needs to be called in Vue Router 3 so that the hook is resolved.\n    if (next) {\n      next();\n    }\n  });\n}\n\nfunction getActiveRootSpan(): Span | undefined {\n  const span = getActiveSpan();\n  const rootSpan = span && getRootSpan(span);\n\n  if (!rootSpan) {\n    return undefined;\n  }\n\n  const op = spanToJSON(rootSpan).op;\n\n  // Only use this root span if it is a pageload or navigation span\n  return op === 'navigation' || op === 'pageload' ? rootSpan : undefined;\n}\n"],"names":[],"mappings":"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"}