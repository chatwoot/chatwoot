# Taskfile for managing Chatwoot operations
# This file provides convenient shortcuts for building, running, and managing
# the ChatsCommerce-branded Chatwoot instance.
# For more information, visit: https://taskfile.dev/

version: "3"

dotenv: [".env"]

vars:
  PROJECT_NAME: chatscommerce
  IMAGE_NAME: chatwoot-branded
  IMAGE_TAG: latest
  COMPOSE_FILE: docker-compose.custom.yaml
  DEV_COMPOSE_FILE: docker-compose.dev.yaml
  COMPOSE_CMD: docker compose

tasks:
  docker-build:
    desc: "Build the ChatsCommerce-branded Chatwoot Docker image"
    cmds:
      - echo "Building the {{.PROJECT_NAME}} branded Chatwoot Docker image..."
      - docker build -t {{.IMAGE_NAME}}:{{.IMAGE_TAG}} -f Dockerfile.custom .

  docker-build-dev:
    desc: "Build the development Docker image"
    cmds:
      - echo "Building the development Docker image..."
      - docker build -t {{.IMAGE_NAME}}:dev -f Dockerfile.dev .

  docker-up: 
    desc: "Start all Chatwoot services in detached mode"
    cmds:
      - "{{.COMPOSE_CMD}} -f {{.COMPOSE_FILE}} up -d"

  docker-up-dev:
    desc: "Start all Chatwoot development services in detached mode, clearing caches first"
    deps: [clear-caches]
    cmds:
      - "{{.COMPOSE_CMD}} -f {{.DEV_COMPOSE_FILE}} up -d"

  docker-down:
    desc: "Stop all Chatwoot services"
    cmds:
      - "{{.COMPOSE_CMD}} -f {{.COMPOSE_FILE}} down"

  docker-down-dev:
    desc: "Stop all Chatwoot development services"
    cmds:
      - "{{.COMPOSE_CMD}} -f {{.DEV_COMPOSE_FILE}} down"

  clear-caches:
    desc: "Clear Vite and Rails temporary caches inside the rails container"
    cmds:
      - echo "Clearing Vite cache..."
      - "rm -rf node_modules/.vite"
      - echo "Clearing tmp directory..."
      - "rm -rf ./app/tmp"
      - "rm -rf ./tmp"
      - echo "Caches cleared."

  docker-restart-dev:
    desc: "Restart Chatwoot development services, clearing caches first"
    deps: [clear-caches]
    cmds:
      - echo "Restarting development services..."
      - "{{.COMPOSE_CMD}} -f {{.DEV_COMPOSE_FILE}} restart"
      - echo "Development services restarted"
        
  docker-rebuild:
    desc: "Rebuild and restart all services with local code changes"
    cmds:
      - task: docker-down
      - echo "Building image with local code (no cache)..."
      - docker build --no-cache -t {{.IMAGE_NAME}}:{{.IMAGE_TAG}} -f Dockerfile.custom .
      - task: docker-up
      - echo "Waiting for services to start..."
      - sleep 10
      - echo "Rebuild complete."
      
  docker-rebuild-dev:
    desc: "Rebuild and restart all development services with local code changes"
    cmds:
      - task: docker-down-dev
      - echo "Building development image with local code (no cache)..."
      - docker build --no-cache -t {{.IMAGE_NAME}}:dev -f Dockerfile.dev .
      - task: docker-up-dev
      - echo "Waiting for services to start..."
      - sleep 10
      - echo "Development rebuild complete."

  setup-dirs:
    desc: "Create necessary directories for data persistence"
    cmds:
      - mkdir -p data/postgres data/redis storage public/uploads

  prepare-env:
    desc: "Create .env file from template if it doesn't exist"
    cmds:
      - |
        if [ ! -f .env ]; then
          cp .env.branded .env
          echo "Created .env file from .env.branded template. Please update with your own values."
        fi

  rails-console:
    desc: "Access the Rails console inside the running container"
    cmds:
      - "{{.COMPOSE_CMD}} -f {{.COMPOSE_FILE}} exec rails bundle exec rails console"

  db-prepare:
    desc: "Run database setup and migrations"
    cmds:
      - "{{.COMPOSE_CMD}} -f {{.COMPOSE_FILE}} exec rails bundle exec rails db:create"
      - "{{.COMPOSE_CMD}} -f {{.COMPOSE_FILE}} exec rails bundle exec rails db:migrate"
      - "{{.COMPOSE_CMD}} -f {{.COMPOSE_FILE}} exec rails bundle exec rails db:seed"

  db-prepare-dev:
    desc: "Run database setup and migrations in development environment"
    cmds:
      - "{{.COMPOSE_CMD}} -f {{.DEV_COMPOSE_FILE}} exec rails bundle exec rails db:create"
      - "{{.COMPOSE_CMD}} -f {{.DEV_COMPOSE_FILE}} exec rails bundle exec rails db:migrate"
      - "{{.COMPOSE_CMD}} -f {{.DEV_COMPOSE_FILE}} exec rails bundle exec rails db:seed"

  db-init:
    desc: "Initialize database with basic setup"
    cmds:
      - task: db-prepare
      - echo "Database initialized successfully."

  db-init-dev:
    desc: "Initialize development database with basic setup"
    cmds:
      - task: db-prepare-dev
      - echo "Development database initialized successfully."

  generate-icons:
    desc: "Generate all icon variations from logo.png for branding"
    cmds:
      - |
        # Make script executable if it isn't already
        chmod +x generate_icons.sh
        # Run the script
        ./generate_icons.sh
        echo "Icons generated successfully"
        
  build-swagger:
    desc: "Build and ensure Swagger documentation is available"
    cmds:
      - echo "Building Swagger documentation and ensuring it's accessible..."
      - "{{.COMPOSE_CMD}} -f {{.COMPOSE_FILE}} exec rails bundle exec rake swagger:build"
      - "{{.COMPOSE_CMD}} -f {{.COMPOSE_FILE}} exec rails cp -r /app/swagger /app/public/"
      - |
        echo "Creating volume mount for swagger directory if needed..."
        if ! grep -q "- ./swagger:/app/swagger" {{.COMPOSE_FILE}}; then
          echo "Swagger volume mount not found. You need to add it to your docker-compose.custom.yaml file."
          echo "Add this line under the volumes section of the rails service:"
          echo "      - ./swagger:/app/swagger"
          exit 1
        fi
      - echo "Swagger documentation should now be available at http://localhost:3000/swagger"

  run-all:
    desc: "Complete setup: create directories, prepare environment, verify branding, build image, start services, and prepare database"
    cmds:
      - task: setup-dirs
      - task: prepare-env
      - task: docker-build
      - task: docker-up
      - echo "Waiting for database to be ready..."
      - sleep 10
      - task: db-init

  run-all-dev:
    desc: "Complete development setup: create directories, prepare environment, build dev image, start dev services, and prepare database"
    cmds:
      - task: setup-dirs
      - task: prepare-env
      - task: docker-build-dev
      - task: docker-up-dev
      - echo "Waiting for database to be ready..."
      - sleep 10
      - task: db-init-dev
      - echo "Development environment is ready!"

  open-app:
    desc: "Open the Chatwoot application in the default browser"
    cmds:
      - |
        if [[ "$OSTYPE" == "darwin"* ]]; then
          open http://localhost:3000
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
          xdg-open http://localhost:3000
        else
          echo "Please open http://localhost:3000 in your browser"
        fi 